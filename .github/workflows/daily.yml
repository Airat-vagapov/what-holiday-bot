name: Send daily holidays

on:
  schedule:
    # 08:55 / 08:59 / 09:05 по Москве (MSK = UTC+3) => 05:55 / 05:59 / 06:05 UTC
    - cron: "55 5 * * *"
    - cron: "59 5 * * *"
    - cron: "5 6 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci

      # Получаем "сегодня" в Москве (важно для дедупликации)
      - name: Compute MSK date
        id: msk
        run: echo "today=$(TZ=Europe/Moscow date +%F)" >> $GITHUB_OUTPUT

      # Пытаемся восстановить кэш-флаг "уже отправляли сегодня"
      - name: Restore sent-flag cache
        id: sentcache
        uses: actions/cache@v4
        with:
          path: .cache/sent.txt
          key: sent-${{ github.repository }}-${{ steps.msk.outputs.today }}

      # Если кэш найден — значит уже отправляли сегодня, выходим
      - name: Skip (already sent today)
        if: steps.sentcache.outputs.cache-hit == 'true'
        run: echo "Already sent today (MSK date: ${{ steps.msk.outputs.today }}). Skipping."

      # Если кэша нет — отправляем
      - name: Send message + poll
        if: steps.sentcache.outputs.cache-hit != 'true'
        run: node src/sendDaily.js
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          SEND_POLL: "true"

      # После успешной отправки создаём файл-флаг, который закэшируется
      - name: Write sent-flag
        if: steps.sentcache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache
          echo "${{ steps.msk.outputs.today }}" > .cache/sent.txt